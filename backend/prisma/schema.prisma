generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Product {
  id                  String                      @id @default(uuid())
  name                String
  slug                String                      @unique
  sku                 String?                     @unique
  description         String?
  salePrice           Float?                      // Price in KES
  originalPrice       Float?                      // Compare at price in KES
  enabled             Boolean                     @default(true)
  condition           ProductCondition            @default(NEW)
  brandId             String?
  shippingMethodId    String?                     @default("standard")
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  deletedAt           DateTime?
  brand               Brand?                      @relation(fields: [brandId], references: [id])
  shippingMethod      ShippingMethod?             @relation(fields: [shippingMethodId], references: [id])
  homepageCollections HomepageCollectionProduct[]
  assets              ProductAsset[]
  collections         ProductCollection[]
  optionGroups        ProductOptionGroup[]
  variants            ProductVariant[]

  @@index([slug])
  @@index([enabled])
  @@index([brandId])
  @@index([sku])
  @@index([shippingMethodId])
  @@index([condition])
}

model ProductVariant {
  id          String                 @id @default(uuid())
  productId   String
  name        String
  sku         String                 @unique
  price       Float
  stockOnHand Int                    @default(0)
  enabled     Boolean                @default(true)
  option      String?
  optionValue String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  assetId     String?
  orderLines  OrderLine[]
  asset       Asset?                 @relation(fields: [assetId], references: [id])
  product     Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  options     ProductVariantOption[]

  @@index([productId])
  @@index([sku])
  @@index([enabled])
}

model ProductOptionGroup {
  id        String          @id @default(uuid())
  productId String
  code      String
  name      String
  options   ProductOption[]
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, code])
}

model ProductOption {
  id             String                 @id @default(uuid())
  groupId        String
  code           String
  name           String
  group          ProductOptionGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  variantOptions ProductVariantOption[]

  @@unique([groupId, code])
}

model ProductVariantOption {
  id        String         @id @default(uuid())
  variantId String
  optionId  String
  option    ProductOption  @relation(fields: [optionId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, optionId])
}

model Collection {
  id          String              @id @default(uuid())
  name        String
  slug        String              @unique
  description String?
  parentId    String?
  enabled     Boolean             @default(true)
  showInMostShopped Boolean           @default(false)
  sortOrder   Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  assetId     String?
  banners     Banner[]
  asset       Asset?              @relation(fields: [assetId], references: [id])
  parent      Collection?         @relation("CollectionHierarchy", fields: [parentId], references: [id])
  children    Collection[]        @relation("CollectionHierarchy")
  products    ProductCollection[]

  @@index([slug])
  @@index([parentId])
  @@index([enabled])
}

model ProductCollection {
  id           String     @id @default(uuid())
  productId    String
  collectionId String
  sortOrder    Int        @default(0)
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, collectionId])
  @@index([collectionId])
}

model HomepageCollection {
  id        String                      @id @default(uuid())
  title     String
  slug      String                      @unique
  enabled   Boolean                     @default(true)
  sortOrder Int                         @default(0)
  createdAt DateTime                    @default(now())
  updatedAt DateTime                    @updatedAt
  products  HomepageCollectionProduct[]

  @@index([slug])
  @@index([enabled])
  @@index([sortOrder])
}

model HomepageCollectionProduct {
  id           String             @id @default(uuid())
  collectionId String
  productId    String
  sortOrder    Int                @default(0)
  collection   HomepageCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product      Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
  @@index([collectionId])
}

model Order {
  id                String          @id @default(uuid())
  code              String          @unique
  customerId        String
  state             OrderState      @default(CREATED)
  subTotal          Int
  shipping          Int
  tax               Int
  total             Int
  currencyCode      String          @default("KES")
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  shippingAddressId String?
  billingAddressId  String?
  shippingMethodId  String?
  billingAddress    Address?        @relation("BillingAddress", fields: [billingAddressId], references: [id])
  customer          Customer        @relation(fields: [customerId], references: [id])
  shippingAddress   Address?        @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  shippingMethod    ShippingMethod? @relation(fields: [shippingMethodId], references: [id])
  lines             OrderLine[]
  payments          Payment[]

  @@index([code])
  @@index([customerId])
  @@index([state])
  @@index([createdAt])
}

model OrderLine {
  id        String         @id @default(uuid())
  orderId   String
  variantId String
  quantity  Int
  linePrice Int
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
}

model Customer {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  firstName    String
  lastName     String
  phoneNumber  String?
  enabled      Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  addresses    Address[]
  orders       Order[]

  @@index([email])
}

model Address {
  id              String    @id @default(uuid())
  customerId      String?
  fullName        String
  streetLine1     String
  streetLine2     String?
  city            String
  province        String
  postalCode      String
  country         String    @default("KE")
  phoneNumber     String
  defaultShipping Boolean   @default(false)
  defaultBilling  Boolean   @default(false)
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  billingOrders   Order[]   @relation("BillingAddress")
  shippingOrders  Order[]   @relation("ShippingAddress")

  @@index([customerId])
}

model Payment {
  id            String       @id @default(uuid())
  orderId       String
  method        String       @default("paystack")
  amount        Int
  state         PaymentState @default(PENDING)
  transactionId String?      @unique
  paystackRef   String?      @unique
  metadata      Json?
  errorMessage  String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  order         Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([paystackRef])
  @@index([state])
}

model Asset {
  id            String           @id @default(uuid())
  name          String
  type          AssetType
  mimeType      String
  fileSize      Int
  source        String
  preview       String
  width         Int?
  height        Int?
  createdAt     DateTime         @default(now())
  desktopBanners     Banner[] @relation("BannerDesktopImage")
  mobileBanners      Banner[] @relation("BannerMobileImage")
  blogs              Blog[]
  collections   Collection[]
  products      ProductAsset[]
  variants      ProductVariant[]

  @@index([type])
}

model ProductAsset {
  id        String  @id @default(uuid())
  productId String
  assetId   String
  sortOrder Int     @default(0)
  featured  Boolean @default(false)
  asset     Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, assetId])
  @@index([productId])
}

model Brand {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  description String?
  logoUrl     String?
  enabled     Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@index([slug])
  @@index([enabled])
}

model Blog {
  id          String         @id @default(uuid())
  title       String
  slug        String         @unique
  content     String
  excerpt     String?
  published   Boolean        @default(false)
  publishedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  assetId     String?
  asset       Asset?         @relation(fields: [assetId], references: [id])
  categories  BlogCategory[]

  @@index([slug])
  @@index([published])
  @@index([publishedAt])
}

model BlogCategory {
  id     String @id @default(uuid())
  blogId String
  name   String
  blog   Blog   @relation(fields: [blogId], references: [id], onDelete: Cascade)

  @@index([blogId])
}

model Banner {
  id            String         @id @default(uuid())
  title         String
  slug          String         @unique
  position      BannerPosition
  enabled       Boolean        @default(true)
  sortOrder     Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  desktopImageId      String?
  mobileImageId       String?
  collectionId        String?
  collection          Collection? @relation(fields: [collectionId], references: [id])
  desktopImage        Asset?      @relation("BannerDesktopImage", fields: [desktopImageId], references: [id])
  mobileImage         Asset?      @relation("BannerMobileImage", fields: [mobileImageId], references: [id])

  @@index([position])
  @@index([enabled])
  @@index([sortOrder])
}

model ShippingMethod {
  id          String         @id @default(uuid())
  code        String         @unique
  name        String
  description String?
  enabled     Boolean        @default(true)
  isExpress   Boolean        @default(false) // Express shipping shows banner
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  zones       ShippingZone[]
  orders      Order[]
  products    Product[]

  @@index([code])
  @@index([enabled])
}

model ShippingZone {
  id               String         @id @default(uuid())
  shippingMethodId String
  county           String
  cities           ShippingCity[]
  shippingMethod   ShippingMethod @relation(fields: [shippingMethodId], references: [id], onDelete: Cascade)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([shippingMethodId])
}

model ShippingCity {
  id            String       @id @default(uuid())
  zoneId        String
  cityTown      String
  standardPrice Int          // Price in KES cents for standard shipping
  expressPrice  Int?         // Price in KES cents for express shipping (optional)
  zone          ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId])
}

model AdminUser {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  firstName    String
  lastName     String
  role         AdminRole @default(ADMIN)
  enabled      Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([email])
}

model MarketingCampaign {
  id               String           @id @default(uuid())
  name             String
  subject          String
  content          String
  status           CampaignStatus   @default(DRAFT)
  recipientSegment String?
  openRate         Float            @default(0)
  clickRate        Float            @default(0)
  sentAt           DateTime?
  scheduledAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  emails           MarketingEmail[]

  @@index([status])
  @@index([createdAt])
}

model MarketingSubscriber {
  id             String           @id @default(uuid())
  email          String           @unique
  firstName      String?
  lastName       String?
  status         SubscriberStatus @default(SUBSCRIBED)
  source         String?
  tags           String[]
  customerId     String?
  subscribedAt   DateTime         @default(now())
  unsubscribedAt DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  emails         MarketingEmail[]

  @@index([email])
  @@index([status])
}

model MarketingEmail {
  id           String              @id @default(uuid())
  campaignId   String
  subscriberId String
  subject      String
  content      String
  status       EmailStatus         @default(PENDING)
  openedAt     DateTime?
  clickedAt    DateTime?
  openRate     Float               @default(0)
  clickRate    Float               @default(0)
  revenue      Int                 @default(0)
  sentAt       DateTime?
  createdAt    DateTime            @default(now())
  campaign     MarketingCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  subscriber   MarketingSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([subscriberId])
  @@index([status])
}

model MarketingAutomation {
  id            String         @id @default(uuid())
  name          String
  type          AutomationType
  trigger       String
  enabled       Boolean        @default(false)
  emailTemplate String
  subject       String
  delayMinutes  Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([type])
  @@index([enabled])
}

enum OrderState {
  CREATED
  PAYMENT_PENDING
  PAYMENT_AUTHORIZED
  PAYMENT_SETTLED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentState {
  PENDING
  AUTHORIZED
  SETTLED
  DECLINED
  CANCELLED
  ERROR
}

enum AssetType {
  IMAGE
  VIDEO
  DOCUMENT
}

enum BannerPosition {
  HERO
  DEALS
  DEALS_HORIZONTAL
  MIDDLE
  BOTTOM
  COLLECTION_TOP
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  EDITOR
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  SENT
  PAUSED
}

enum SubscriberStatus {
  SUBSCRIBED
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
}

enum EmailStatus {
  PENDING
  SENT
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum AutomationType {
  ABANDONED_CHECKOUT
  ABANDONED_CART
  ABANDONED_BROWSE
  WELCOME_SUBSCRIBER
  POST_PURCHASE
  WIN_BACK
  BIRTHDAY
  PRODUCT_RECOMMENDATION
}

enum ProductCondition {
  NEW
  REFURBISHED
}

model AbandonedCart {
  id           String    @id @default(uuid())
  sessionId    String    @unique @map("session_id")
  userId       String?   @map("user_id")
  email        String?
  items        Json
  totalValue   Decimal   @map("total_value") @db.Decimal(10, 2)
  lastUpdated  DateTime  @map("last_updated")
  createdAt    DateTime  @default(now()) @map("created_at")
  isAbandoned  Boolean   @default(false) @map("is_abandoned")
  isConverted  Boolean   @default(false) @map("is_converted")
  abandonedAt  DateTime? @map("abandoned_at")

  @@index([sessionId])
  @@index([lastUpdated])
  @@index([isAbandoned])
  @@map("abandoned_carts")
}

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("setting")
}
